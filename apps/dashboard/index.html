<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trolley Monitor - GateGroup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .tabular-nums {
            font-feature-settings: 'tnum';
            font-variant-numeric: tabular-nums;
        }
    </style>
  </head>
<body class="bg-gray-50 antialiased">
    <div class="h-screen flex flex-col overflow-hidden">
        
        <!-- Header -->
        <div class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-6">
                    <h1 class="text-2xl font-bold text-gray-900 tracking-tight">TROLLEY MONITOR</h1>
                    <p class="text-sm text-gray-500 font-mono tabular-nums" id="current-time">26/10/2025, 06:28</p>
                </div>
                <div class="flex items-center gap-4">
                    <select id="trolley-selector" class="bg-white text-gray-900 text-base font-medium px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 shadow-sm">
                        <option value="1">Trolley 1</option>
                        <option value="2">Trolley 2</option>
                        <option value="3">Trolley 3</option>
                    </select>
                    <div id="connection-indicator" class="flex items-center gap-2 px-4 py-2 rounded-lg border text-sm font-semibold bg-red-50 text-red-700 border-red-200">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414"/>
                        </svg>
                        <span id="connection-text">DESCONECTADO</span>
                        <div class="w-2 h-2 rounded-full bg-red-600" id="connection-dot"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 px-6 py-5 overflow-hidden">
            <div class="h-full flex flex-col gap-4">
                
                <!-- KPI Cards -->
                <div class="grid grid-cols-4 gap-4">
                    <!-- Productos -->
                    <div class="bg-white rounded-lg border border-gray-200 p-5 shadow-sm">
                        <div class="flex items-center justify-center mb-3">
                            <div class="p-3 rounded-full bg-gray-100">
                                <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                </svg>
                            </div>
                        </div>
                        <div class="text-center space-y-1">
                            <p class="text-gray-500 text-xs font-semibold uppercase tracking-wider">PRODUCTOS</p>
                            <p class="text-gray-900 text-3xl font-bold tabular-nums" id="kpi-products">0</p>
                            <p class="text-gray-400 text-xs font-medium">√∫nicos</p>
                        </div>
                            </div>

                    <!-- Escaneados -->
                    <div class="bg-white rounded-lg border border-gray-200 p-5 shadow-sm">
                        <div class="flex items-center justify-center mb-3">
                            <div class="p-3 rounded-full bg-gray-100">
                                <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="text-center space-y-1">
                            <p class="text-gray-500 text-xs font-semibold uppercase tracking-wider">ESCANEADOS</p>
                            <p class="text-gray-900 text-3xl font-bold tabular-nums" id="kpi-scanned">0</p>
                            <p class="text-gray-400 text-xs font-medium">total</p>
                        </div>
                    </div>

                    <!-- Confianza -->
                    <div class="bg-white rounded-lg border border-gray-200 p-5 shadow-sm">
                        <div class="flex items-center justify-center mb-3">
                            <div class="p-3 rounded-full bg-gray-100">
                                <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="text-center space-y-1">
                            <p class="text-gray-500 text-xs font-semibold uppercase tracking-wider">CONFIANZA</p>
                            <p class="text-gray-900 text-3xl font-bold tabular-nums" id="kpi-confidence">94%</p>
                            <p class="text-gray-400 text-xs font-medium">precisi√≥n</p>
                                </div>
                            </div>

                    <!-- Tiempo -->
                    <div class="bg-white rounded-lg border border-gray-200 p-5 shadow-sm">
                        <div class="flex items-center justify-center mb-3">
                            <div class="p-3 rounded-full bg-gray-100">
                                <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="text-center space-y-1">
                            <p class="text-gray-500 text-xs font-semibold uppercase tracking-wider">TIEMPO</p>
                            <p class="text-gray-900 text-3xl font-bold tabular-nums" id="kpi-time">7s</p>
                            <p class="text-gray-400 text-xs font-medium">activo</p>
                        </div>
                    </div>
                </div>

                <!-- Main Grid -->
                <div class="flex-1 grid grid-cols-3 gap-4 overflow-hidden">
                    <!-- Panel Izquierdo - Checklist de Productos -->
                    <div class="col-span-2 bg-white rounded-lg border border-gray-200 shadow-sm flex flex-col overflow-hidden">
                        <div class="px-5 py-4 border-b border-gray-200 flex items-center justify-between">
                            <h2 class="text-sm font-bold text-gray-900 uppercase tracking-wide">PRODUCTOS DETECTADOS</h2>
                            <select id="checklist-selector" class="bg-white text-gray-900 text-xs px-3 py-1.5 rounded-lg border border-gray-300 focus:outline-none focus:ring-1 focus:ring-gray-400">
                                        <option value="">Seleccionar Checklist</option>
                                <option value="bebidas">ü•§ Checklist Bebidas</option>
                                <option value="snacks">üçø Checklist Snacks</option>
                                <option value="refrescos">ü•§ Checklist Refrescos</option>
                                <option value="papas">ü•î Checklist Papas</option>
                                <option value="mixto">üõí Checklist Mixto</option>
                                    </select>
                                    </div>
                        <div class="flex-1 overflow-y-auto p-5">
                            <div id="checklist-list" class="space-y-3">
                                <div class="flex items-center justify-center h-full">
                                    <p class="text-base text-gray-400 font-medium">Selecciona una checklist para comenzar</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel Derecho - Info Vuelo y Actividad -->
                    <div class="flex flex-col gap-4 overflow-hidden">
                        <!-- Informaci√≥n del Vuelo -->
                        <div class="flex-1 bg-white rounded-lg border border-gray-200 shadow-sm flex flex-col overflow-hidden">
                            <div class="px-5 py-4 border-b border-gray-200">
                                <h2 class="text-sm font-bold text-gray-900 uppercase tracking-wide">INFORMACI√ìN DEL VUELO</h2>
                                </div>
                            <div class="flex-1 overflow-y-auto p-5">
                                <div id="flight-info" class="space-y-3">
                                    <!-- Se llenar√° con JS -->
                                </div>
                            </div>
                        </div>

                        <!-- Actividad / Inventario de Ventas -->
                        <div class="flex-1 bg-white rounded-lg border border-gray-200 shadow-sm flex flex-col overflow-hidden">
                            <div class="px-5 py-4 border-b border-gray-200">
                                <h2 class="text-sm font-bold text-gray-900 uppercase tracking-wide">ACTIVIDAD</h2>
                            </div>
                            <div class="flex-1 overflow-y-auto p-5">
                                <div id="activity-list" class="space-y-3">
                                    <!-- M√©tricas de Ventas -->
                                    <div class="bg-blue-50 rounded-lg p-3 border border-blue-100">
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-blue-700 font-semibold uppercase">Cargados</span>
                                            <span class="font-bold text-blue-800 text-lg tabular-nums" id="loaded-count">0</span>
                                        </div>
                                    </div>
                                    <div class="bg-green-50 rounded-lg p-3 border border-green-100">
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-green-700 font-semibold uppercase">Vendidos</span>
                                            <span class="font-bold text-green-800 text-lg tabular-nums" id="sold-count">0</span>
                                        </div>
                                    </div>
                                    <div class="bg-orange-50 rounded-lg p-3 border border-orange-100">
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-orange-700 font-semibold uppercase">Retornados</span>
                                            <span class="font-bold text-orange-800 text-lg tabular-nums" id="returned-count">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer - Status Bar -->
                <div class="bg-white rounded-lg border border-gray-200 px-5 py-3 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4 text-sm">
                            <span class="font-bold text-gray-400" id="recording-status">‚óã DETENIDO</span>
                            <span class="text-gray-300">|</span>
                            <span class="text-gray-600 font-mono" id="scan-info">Scan #1</span>
                            <span class="text-gray-300">|</span>
                            <span class="text-gray-600 font-mono" id="operator-info">Op. 1</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Global state
        let socket = null;
        let isConnected = false;
        let productsDetected = new Map();
        let startTime = Date.now();
        
        // Sales tracking state
        let loadedProducts = new Set();
        let returnedProducts = new Set();
        let currentScanId = null;
        
        // Flight data - Hardcodeado por trolley
        const FLIGHT_DATA = {
            1: {
                flightNumber: 'AM 456',
                route: 'MEX ‚Üí NYC',
                origin: 'Ciudad de M√©xico',
                destination: 'Nueva York',
                departureTime: '14:30',
                date: '26/10/2025',
                aircraft: 'Boeing 737-800',
                passengers: 186,
                class: 'Econ√≥mica'
            },
            2: {
                flightNumber: 'AM 789',
                route: 'GDL ‚Üí LAX',
                origin: 'Guadalajara',
                destination: 'Los √Ångeles',
                departureTime: '16:45',
                date: '26/10/2025',
                aircraft: 'Airbus A320',
                passengers: 156,
                class: 'Premier'
            },
            3: {
                flightNumber: 'AM 123',
                route: 'MTY ‚Üí MIA',
                origin: 'Monterrey',
                destination: 'Miami',
                departureTime: '18:15',
                date: '26/10/2025',
                aircraft: 'Boeing 787-9',
                passengers: 243,
                class: 'Clase AM Plus'
            }
        };
        
        // Checklist state
        const CHECKLIST_TEMPLATES = {
            bebidas: {
                id: 'bebidas',
                name: 'ü•§ Checklist Bebidas',
                products: [
                    { id: 1, name: 'Santa Clara Chocolate', category: 'Confiter√≠a' },
                    { id: 2, name: 'Coca-Cola Regular Lata', category: 'Bebidas' },
                    { id: 3, name: 'Coca-Cola Light Lata', category: 'Bebidas' },
                    { id: 5, name: 'Doritos Nacho', category: 'Snacks' },
                    { id: 6, name: 'Lays Original', category: 'Snacks' }
                ]
            },
            snacks: {
                id: 'snacks',
                name: 'üçø Checklist Snacks',
                products: [
                    { id: 2, name: 'Coca-Cola Regular Lata', category: 'Bebidas' },
                    { id: 3, name: 'Coca-Cola Light Lata', category: 'Bebidas' },
                    { id: 4, name: 'Takis Fuego', category: 'Snacks' },
                    { id: 5, name: 'Doritos Nacho', category: 'Snacks' },
                    { id: 6, name: 'Lays Original', category: 'Snacks' }
                ]
            },
            refrescos: {
                id: 'refrescos',
                name: 'ü•§ Checklist Refrescos',
                products: [
                    { id: 1, name: 'Santa Clara Chocolate', category: 'Confiter√≠a' },
                    { id: 2, name: 'Coca-Cola Regular Lata', category: 'Bebidas' },
                    { id: 3, name: 'Coca-Cola Light Lata', category: 'Bebidas' },
                    { id: 4, name: 'Takis Fuego', category: 'Snacks' },
                    { id: 6, name: 'Lays Original', category: 'Snacks' }
                ]
            },
            papas: {
                id: 'papas',
                name: 'ü•î Checklist Papas',
                products: [
                    { id: 1, name: 'Santa Clara Chocolate', category: 'Confiter√≠a' },
                    { id: 2, name: 'Coca-Cola Regular Lata', category: 'Bebidas' },
                    { id: 4, name: 'Takis Fuego', category: 'Snacks' },
                    { id: 5, name: 'Doritos Nacho', category: 'Snacks' },
                    { id: 6, name: 'Lays Original', category: 'Snacks' }
                ]
            },
            mixto: {
                id: 'mixto',
                name: 'üõí Checklist Mixto',
                products: [
                    { id: 1, name: 'Santa Clara Chocolate', category: 'Confiter√≠a' },
                    { id: 2, name: 'Coca-Cola Regular Lata', category: 'Bebidas' },
                    { id: 3, name: 'Coca-Cola Light Lata', category: 'Bebidas' },
                    { id: 4, name: 'Takis Fuego', category: 'Snacks' },
                    { id: 5, name: 'Doritos Nacho', category: 'Snacks' }
                ]
            }
        };
        
        let activeChecklist = null;
        let checklistItems = new Map();

        // Category emojis
        const categoryEmojis = {
            'Bebidas': 'ü•§',
            'Snacks': 'üçø',
            'Botanas': 'ü•î',
            'Confiter√≠a': 'üç´',
            'L√°cteos': 'ü•õ',
            'default': 'üì¶'
        };

        function getCategoryEmoji(category) {
            return categoryEmojis[category] || categoryEmojis.default;
        }

        // Update clock
        function updateClock() {
            const now = new Date();
            const formatted = now.toLocaleString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('current-time').textContent = formatted;
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const indicator = document.getElementById('connection-indicator');
            const text = document.getElementById('connection-text');
            const dot = document.getElementById('connection-dot');
            
            if (connected) {
                indicator.className = 'flex items-center gap-2 px-4 py-2 rounded-lg border text-sm font-semibold bg-green-50 text-green-700 border-green-200';
                text.textContent = 'CONECTADO';
                dot.className = 'w-2 h-2 rounded-full bg-green-600 animate-pulse';
            } else {
                indicator.className = 'flex items-center gap-2 px-4 py-2 rounded-lg border text-sm font-semibold bg-red-50 text-red-700 border-red-200';
                text.textContent = 'DESCONECTADO';
                dot.className = 'w-2 h-2 rounded-full bg-red-600';
            }
        }

        // Handle sales tracking
        function handleSalesTracking(event) {
            const scanType = event.scan_type || 'load';
            const productId = event.product_id;
            
            if (scanType === 'load') {
                console.log('üì¶ [LOAD] Producto cargado:', event.product_name);
                loadedProducts.add(productId);
            } else if (scanType === 'return') {
                console.log('üîÑ [RETURN] Producto retornado:', event.product_name);
                returnedProducts.add(productId);
            }
            
            updateSalesMetrics();
        }

        // Update sales metrics
        function updateSalesMetrics() {
            const loadedCount = loadedProducts.size;
            const returnedCount = returnedProducts.size;
            const soldCount = loadedCount - returnedCount;
            
            console.log('üí∞ Sales Metrics Updated:', {
                loaded: loadedCount,
                returned: returnedCount,
                sold: soldCount
            });
            
            document.getElementById('loaded-count').textContent = loadedCount;
            document.getElementById('returned-count').textContent = returnedCount;
            document.getElementById('sold-count').textContent = soldCount;
        }

        // Handle product detection
        function handleProductDetected(event) {
            const productId = event.product_id;
            const productName = event.product_name;
            const category = event.category || 'Sin categor√≠a';
            const confidence = event.confidence;

            // Store or update product
            if (!productsDetected.has(productId)) {
                productsDetected.set(productId, {
                    id: productId,
                    name: productName,
                    category: category,
                    confidence: confidence,
                    count: 1
                });
            } else {
                const existing = productsDetected.get(productId);
                existing.count += 1;
            }

            updateKPIs();
        }

        // Checklist functions
        function loadChecklist(templateId) {
            const template = CHECKLIST_TEMPLATES[templateId];
            if (!template) return;
            
            activeChecklist = template;
            checklistItems.clear();
            
            // Initialize all items as pending
            template.products.forEach(product => {
                checklistItems.set(product.id, {
                    status: 'pending',
                    detectedAt: null,
                    confidence: 0
                });
            });
            
            renderChecklist();
        }
        
        function renderChecklist() {
            const checklistList = document.getElementById('checklist-list');
            
            if (!activeChecklist) {
                checklistList.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <p class="text-base text-gray-400 font-medium">Selecciona una checklist para comenzar</p>
                    </div>
                `;
                return;
            }
            
            const items = activeChecklist.products.map(product => {
                const item = checklistItems.get(product.id);
                const status = item ? item.status : 'pending';
                const detectedAt = item ? item.detectedAt : null;
                const confidence = item ? item.confidence : 0;
                const confidencePercent = Math.round(confidence * 100);
                
                const isDetected = status === 'detected' || status === 'completed';
                
                const time = detectedAt 
                    ? new Date(detectedAt).toLocaleTimeString('es-ES', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    })
                    : '--:--:--';
                
                return `
                    <div class="bg-${isDetected ? 'gray' : 'white'}-50 rounded-lg border border-gray-200 p-4 transition-all ${isDetected ? 'shadow-sm' : ''}">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                ${isDetected 
                                    ? '<svg class="w-5 h-5 text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
                                    : '<svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/></svg>'
                                }
                                <div>
                                    <h3 class="text-gray-900 font-semibold text-base">${product.name}</h3>
                                    <p class="text-gray-500 text-sm">${product.category}</p>
                                </div>
                            </div>
                            <span class="text-sm text-gray-500 font-mono tabular-nums">${time}</span>
                        </div>
                        ${isDetected ? `
                            <div class="flex items-center gap-3 mt-3">
                                <div class="flex-1">
                                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                        <div class="h-full bg-gray-700 transition-all duration-500" style="width: ${confidencePercent}%"></div>
                                    </div>
                                </div>
                                <span class="text-sm text-gray-600 font-mono font-semibold tabular-nums">${confidencePercent}%</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            checklistList.innerHTML = items;
        }
        
        function handleChecklistProductDetected(event) {
            if (!activeChecklist) {
                console.log('‚ö†Ô∏è No active checklist selected');
                return;
            }
            
            const productName = event.product_name;
            let product = activeChecklist.products.find(p => {
                const name1 = p.name.toLowerCase();
                const name2 = productName.toLowerCase();
                return name1.includes(name2) || name2.includes(name1);
            });
            
            if (!product) {
                console.log('‚ùå Product not in checklist:', productName);
                return;
            }
            
            const currentItem = checklistItems.get(product.id);
            if (!currentItem) return;
            
            currentItem.status = 'detected';
            currentItem.detectedAt = event.detected_at;
            currentItem.confidence = event.confidence;
            
            checklistItems.set(product.id, currentItem);
            
            console.log('‚úÖ Checklist item updated:', product.name);
            renderChecklist();
        }

        // Update KPIs
        function updateKPIs() {
            const uniqueProducts = productsDetected.size;
            const totalDetections = Array.from(productsDetected.values()).reduce((sum, p) => sum + p.count, 0);
            const avgConfidence = productsDetected.size > 0
                ? Array.from(productsDetected.values()).reduce((sum, p) => sum + p.confidence, 0) / productsDetected.size
                : 0.94;
            const activeTime = Math.floor((Date.now() - startTime) / 1000);

            document.getElementById('kpi-products').textContent = uniqueProducts;
            document.getElementById('kpi-scanned').textContent = totalDetections;
            document.getElementById('kpi-confidence').textContent = Math.round(avgConfidence * 100) + '%';
            
            const minutes = Math.floor(activeTime / 60);
            const seconds = activeTime % 60;
            document.getElementById('kpi-time').textContent = minutes > 0 
                ? `${minutes}m ${seconds}s` 
                : `${seconds}s`;
        }

        // Update flight info
        function updateFlightInfo() {
            const trolleyId = parseInt(document.getElementById('trolley-selector').value);
            const flight = FLIGHT_DATA[trolleyId];
            const container = document.getElementById('flight-info');
            
            if (!flight) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <p class="text-base text-gray-400 font-medium">Sin datos de vuelo</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <!-- N√∫mero de Vuelo -->
                <div class="bg-blue-50 rounded-lg p-3 border border-blue-100">
                    <div class="flex items-center gap-2 mb-1">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                        <span class="text-xs text-blue-600 font-semibold uppercase">Vuelo</span>
                    </div>
                    <p class="text-blue-900 font-bold text-lg">${flight.flightNumber}</p>
                </div>

                <!-- Ruta -->
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                    <div class="flex items-center gap-2 mb-1">
                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <span class="text-xs text-gray-600 font-semibold uppercase">Ruta</span>
                    </div>
                    <p class="text-gray-900 font-bold text-base">${flight.route}</p>
                    <p class="text-gray-500 text-xs mt-1">${flight.origin} ‚Üí ${flight.destination}</p>
                </div>

                <!-- Horario -->
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                    <div class="flex items-center gap-2 mb-1">
                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="text-xs text-gray-600 font-semibold uppercase">Salida</span>
                    </div>
                    <p class="text-gray-900 font-bold text-base tabular-nums">${flight.departureTime}</p>
                    <p class="text-gray-500 text-xs mt-1">${flight.date}</p>
                </div>

                <!-- Aeronave -->
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                    <div class="flex items-center gap-2 mb-1">
                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span class="text-xs text-gray-600 font-semibold uppercase">Aeronave</span>
                    </div>
                    <p class="text-gray-900 font-semibold text-sm">${flight.aircraft}</p>
                    <p class="text-gray-500 text-xs mt-1">${flight.passengers} pasajeros ‚Ä¢ ${flight.class}</p>
                </div>
            `;
        }

        // Initialize WebSocket
        function initWebSocket() {
            try {
                console.log('üîå Dashboard connecting to WebSocket...');
                socket = io('ws://localhost:3001/ws', {
                    transports: ['websocket', 'polling'],
                    reconnection: true,
                    reconnectionDelay: 1000,
                    reconnectionAttempts: 5,
                });

                socket.on('connect', () => {
                    console.log('‚úÖ Dashboard WebSocket connected');
                    console.log('üÜî Socket ID:', socket.id);
                    
                    const trolleyId = document.getElementById('trolley-selector').value;
                    socket.emit('join_trolley_room', { trolleyId: parseInt(trolleyId) });
                    console.log('üè† Joined trolley room', trolleyId);
                    
                    updateConnectionStatus(true);
                });

                socket.on('disconnect', () => {
                    console.log('‚ùå Dashboard WebSocket disconnected');
                    updateConnectionStatus(false);
                });

                socket.on('product_detected', (event) => {
                    console.log('üéØ Product detected:', event.product_name);
                    console.log('üìù Event details:', {
                        product_id: event.product_id,
                        category: event.category,
                        confidence: event.confidence,
                        scan_type: event.scan_type
                    });
                    handleProductDetected(event);
                    handleChecklistProductDetected(event);
                    handleSalesTracking(event);
                });

                socket.onAny((eventName, ...args) => {
                    console.log('üì° Dashboard received event:', eventName, args);
                });

                socket.on('connect_error', (error) => {
                    console.warn('‚ö†Ô∏è WebSocket error:', error.message);
                    updateConnectionStatus(false);
                });

            } catch (error) {
                console.error('‚ùå Error initializing WebSocket:', error);
                updateConnectionStatus(false);
            }
        }

        // Initialize checklist selector
        function initChecklistSelector() {
            const selector = document.getElementById('checklist-selector');
            if (!selector) return;
            
            selector.addEventListener('change', (e) => {
                const templateId = e.target.value;
                console.log('üìã Checklist selected:', templateId);
                
                if (templateId) {
                    loadChecklist(templateId);
            } else {
                    activeChecklist = null;
                    checklistItems.clear();
                    renderChecklist();
                }
            });
            
            console.log('‚úÖ Checklist selector initialized');
        }

        // Trolley selector change
        function initTrolleySelector() {
            const selector = document.getElementById('trolley-selector');
            if (!selector) return;
            
            selector.addEventListener('change', (e) => {
                const trolleyId = e.target.value;
                console.log('üîÑ Switching to trolley:', trolleyId);
                
                productsDetected.clear();
                loadedProducts.clear();
                returnedProducts.clear();
                
                if (socket && socket.connected) {
                    socket.emit('join_trolley_room', { trolleyId: parseInt(trolleyId) });
                    console.log('üè† Joined trolley room', trolleyId);
                }
                
                updateKPIs();
                updateFlightInfo();
                updateSalesMetrics();
            });
        }

        // Initialize dashboard
        function initDashboard() {
            console.log('üöÄ Initializing Smart Trolley Dashboard');
            initWebSocket();
            initChecklistSelector();
            initTrolleySelector();
            updateKPIs();
            updateSalesMetrics();
            updateFlightInfo();
            
            // Update clock every second
            setInterval(updateClock, 1000);
            
            // Update KPIs every second
            setInterval(updateKPIs, 1000);
        }

        // Start on load
        window.addEventListener('DOMContentLoaded', initDashboard);
    </script>
  </body>
</html>
